<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ø–æ –û–ü</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        th, td {
            border: 1px solid #333;
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
        }
        
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        .row-label {
            background-color: #f2f2f2;
            font-weight: bold;
            text-align: left;
        }
        
        .group-title {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .button-container {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –¥–∞—Ç—ã */
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 15px;
        }
        
        .report-date {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è PDF-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        #pdf-content {
            background-color: white;
            padding: 20px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
            page-break-inside: avoid;
        }
        
        .chart-box {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            page-break-inside: avoid;
        }
        
        .chart-box h3 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        canvas {
            width: 100% !important;
            height: auto !important;
            max-height: 200px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ PDF */
        @media print {
            .button-container {
                display: none;
            }
            #pdf-content {
                padding: 0;
            }
            .charts-container {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ (–ù–ï –≤—Ö–æ–¥–∏—Ç –≤ PDF) -->
        <div class="button-container">
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ø–∏—Å–∫—É —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
            <a href="all_students">
                <button class="btn btn-primary">üë• –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</button>
            </a>
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF -->
            <button class="btn btn-success" onclick="downloadPDF()">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç –≤ PDF</button>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è PDF (–≤–∫–ª—é—á–∞–µ—Ç –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á—ë—Ç–∞) -->
        <div id="pdf-content">
            <!-- –®–∞–ø–∫–∞ –æ—Ç—á—ë—Ç–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º –∏–∑ –ë–î -->
            <div class="report-header">
                <h2>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ø–æ –û–ü {{ report_date|date:"d E Y" }} | –í—Ä–µ–º—è: {{ report_date|time:"H:i:s" }}</h2>
                
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–æ—Ö–æ–¥–Ω—ã–º –±–∞–ª–ª–æ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å -->
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                        <th colspan="4">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</th>
                    </tr>
                    <tr>
                        <th>–ü–ú</th>
                        <th>–ò–í–¢</th>
                        <th>–ò–¢–°–°</th>
                        <th>–ò–ë</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- –û–±—â–µ–µ –∫–æ–ª-–≤–æ –∑–∞—è–≤–ª–µ–Ω–∏–π -->
                    <tr>
                        <td class="row-label">–û–±—â–µ–µ –∫–æ–ª-–≤–æ –∑–∞—è–≤–ª–µ–Ω–∏–π</td>
                        <td>{{ data.pm.total_applications }}</td>
                        <td>{{ data.ivt.total_applications }}</td>
                        <td>{{ data.itss.total_applications }}</td>
                        <td>{{ data.ib.total_applications }}</td>
                    </tr>
                    <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –Ω–∞ –û–ü -->
                    <tr>
                        <td class="row-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –Ω–∞ –û–ü</td>
                        <td>{{ data.pm.places }}</td>
                        <td>{{ data.ivt.places }}</td>
                        <td>{{ data.itss.places }}</td>
                        <td>{{ data.ib.places }}</td>
                    </tr>
                    <!-- –ë–ª–æ–∫ –∑–∞—è–≤–ª–µ–Ω–∏–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º -->
                    <tr class="group-title">
                        <td colspan="5">üìù –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞—è–≤–ª–µ–Ω–∏–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—è–≤–ª–µ–Ω–∏–π 1-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.priority_1_apps }}</td>
                        <td>{{ data.ivt.priority_1_apps }}</td>
                        <td>{{ data.itss.priority_1_apps }}</td>
                        <td>{{ data.ib.priority_1_apps }}</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—è–≤–ª–µ–Ω–∏–π 2-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.priority_2_apps }}</td>
                        <td>{{ data.ivt.priority_2_apps }}</td>
                        <td>{{ data.itss.priority_2_apps }}</td>
                        <td>{{ data.ib.priority_2_apps }}</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—è–≤–ª–µ–Ω–∏–π 3-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.priority_3_apps }}</td>
                        <td>{{ data.ivt.priority_3_apps }}</td>
                        <td>{{ data.itss.priority_3_apps }}</td>
                        <td>{{ data.ib.priority_3_apps }}</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—è–≤–ª–µ–Ω–∏–π 4-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.priority_4_apps }}</td>
                        <td>{{ data.ivt.priority_4_apps }}</td>
                        <td>{{ data.itss.priority_4_apps }}</td>
                        <td>{{ data.ib.priority_4_apps }}</td>
                    </tr>
                    <!-- –ë–ª–æ–∫ –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º -->
                    <tr class="group-title">
                        <td colspan="5">‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö 1-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.enrolled_1 }}</td>
                        <td>{{ data.ivt.enrolled_1 }}</td>
                        <td>{{ data.itss.enrolled_1 }}</td>
                        <td>{{ data.ib.enrolled_1 }}</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö 2-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.enrolled_2 }}</td>
                        <td>{{ data.ivt.enrolled_2 }}</td>
                        <td>{{ data.itss.enrolled_2 }}</td>
                        <td>{{ data.ib.enrolled_2 }}</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö 3-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.enrolled_3 }}</td>
                        <td>{{ data.ivt.enrolled_3 }}</td>
                        <td>{{ data.itss.enrolled_3 }}</td>
                        <td>{{ data.ib.enrolled_3 }}</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ö–æ–ª-–≤–æ –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö 4-–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</td>
                        <td>{{ data.pm.enrolled_4 }}</td>
                        <td>{{ data.ivt.enrolled_4 }}</td>
                        <td>{{ data.itss.enrolled_4 }}</td>
                        <td>{{ data.ib.enrolled_4 }}</td>
                    </tr>
                    <!-- –°—Ç—Ä–æ–∫–∞ —Å –ø—Ä–æ—Ö–æ–¥–Ω—ã–º –±–∞–ª–ª–æ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å -->
                    <tr class="group-title">
                        <td colspan="5">üéØ –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª (–∑–∞ {{ last_day_date|date:"d.m" }})</td>
                    </tr>
                    <tr>
                        <td class="row-label">–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª</td>
                        <td>{{ data.pm.last_day_score }}</td>
                        <td>{{ data.ivt.last_day_score }}</td>
                        <td>{{ data.itss.last_day_score }}</td>
                        <td>{{ data.ib.last_day_score }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- –ë–ª–æ–∫ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥–Ω–æ–≥–æ –±–∞–ª–ª–∞ -->
            <h3 style="text-align: center; margin: 30px 0 20px;">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ—Ö–æ–¥–Ω–æ–≥–æ –±–∞–ª–ª–∞ –∑–∞ 4 –¥–Ω—è</h3>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (2x2 –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏) -->
            <div class="charts-container">
                <div class="chart-box">
                    <h3>–ü–ú</h3>
                    <canvas id="chart-pm" data-dates='{{ dynamics_dates|safe }}' data-values='{{ dynamics.pm|safe }}'></canvas>
                </div>
                <div class="chart-box">
                    <h3>–ò–í–¢</h3>
                    <canvas id="chart-ivt" data-dates='{{ dynamics_dates|safe }}' data-values='{{ dynamics.ivt|safe }}'></canvas>
                </div>
                <div class="chart-box">
                    <h3>–ò–¢–°–°</h3>
                    <canvas id="chart-itss" data-dates='{{ dynamics_dates|safe }}' data-values='{{ dynamics.itss|safe }}'></canvas>
                </div>
                <div class="chart-box">
                    <h3>–ò–ë</h3>
                    <canvas id="chart-ib" data-dates='{{ dynamics_dates|safe }}' data-values='{{ dynamics.ib|safe }}'></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        let charts = {};

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Django –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        function createCharts() {
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
            const pmCanvas = document.getElementById('chart-pm');
            const ivtCanvas = document.getElementById('chart-ivt');
            const itssCanvas = document.getElementById('chart-itss');
            const ibCanvas = document.getElementById('chart-ib');
            
            // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ (–æ–Ω–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–∑ Django –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ)
            const dates = JSON.parse(pmCanvas.dataset.dates);
            const pmData = JSON.parse(pmCanvas.dataset.values);
            const ivtData = JSON.parse(ivtCanvas.dataset.values);
            const itssData = JSON.parse(itssCanvas.dataset.values);
            const ibData = JSON.parse(ibCanvas.dataset.values);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '–ë–∞–ª–ª'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 500
                    },
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    }
                }
            };
            
            // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –ü–ú
            charts.pm = new Chart(pmCanvas, {
                ...chartConfig,
                data: {
                    labels: dates,
                    datasets: [{
                        data: pmData,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3
                    }]
                }
            });
            
            // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –ò–í–¢
            charts.ivt = new Chart(ivtCanvas, {
                ...chartConfig,
                data: {
                    labels: dates,
                    datasets: [{
                        data: ivtData,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#2196F3',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3
                    }]
                }
            });
            
            // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –ò–¢–°–°
            charts.itss = new Chart(itssCanvas, {
                ...chartConfig,
                data: {
                    labels: dates,
                    datasets: [{
                        data: itssData,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#FF9800',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3
                    }]
                }
            });
            
            // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –ò–ë
            charts.ib = new Chart(ibCanvas, {
                ...chartConfig,
                data: {
                    labels: dates,
                    datasets: [{
                        data: ibData,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#f44336',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3
                    }]
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞ –≤ PDF
        function downloadPDF() {
            const element = document.getElementById('pdf-content');
            
            const opt = {
                margin:        [0.1, 0.1, 0.1, 0.1],
                filename:     'svodny_otchet_po_op.pdf',
                image:        { type: 'jpeg', quality: 0.95 },
                html2canvas:  { scale: 2, letterRendering: true, logging: false },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
            };
            
            // –°–∫–∞—á–∏–≤–∞–µ–º PDF
            html2pdf().set(opt).from(element).save();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
            createCharts();
        });
    </script>
</body>
</html>